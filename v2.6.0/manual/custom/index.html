<!DOCTYPE html><HTML lang="en"><head><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Custom nodes · Mill.jl</title><script data-outdated-warner="" src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script data-main="../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/><script data-is-old-version="">document.addEventListener("DOMContentLoaded", function () {
    if (document.body.querySelector('meta[name="robots"]') === null) {
        const meta = document.createElement('meta');
        meta.name = 'robots';
        meta.content = 'noindex';

        document.getElementsByTagName('head')[0].appendChild(meta);
    };

    const div = document.createElement('div');
    div.setAttribute('style', 'position: fixed; width: 100%; top: 0; left: 0; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 999; background-color: #ffaf9c; color: rgba(0, 0, 0, 0.7); border-bottom: 1px solid #d54625; padding: 10px 35px; text-align: center; font-size: 15px;');
    const closer = document.createElement('div');
    closer.setAttribute('style', 'position: absolute; top: calc(50% - 8px); right: 18px; cursor: pointer; width: 12px;');
    // Icon by font-awesome (license: https://fontawesome.com/license, link: https://fontawesome.com/icons/times?style=solid)
    closer.innerHTML = '<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" class="svg-inline--fa fa-times fa-w-11" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"></path></svg>';
    closer.addEventListener('click', function () {
        document.body.removeChild(div);
    });
    let href = '/stable';
    if (window.documenterBaseURL) {
        href = window.documenterBaseURL + '/../stable';
    }
    div.innerHTML = 'This is an old version of the documentation. <br> <a href="' + href + '" style="color: rgb(46, 99, 184)">Go to the newest version</a>.';
    div.appendChild(closer);
    document.body.appendChild(div);
});
</script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img alt="Mill.jl logo" src="../../assets/logo.svg"/></a><form action="../../search/" class="docs-search"><input class="docs-search-query" id="documenter-search-query" name="q" placeholder="Search docs" type="text"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../motivation/">Motivation</a></li><li><input checked="" class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../nodes/">Nodes</a></li><li><a class="tocitem" href="../more_on_nodes/">More on nodes</a></li><li><a class="tocitem" href="../reflectin/">Model reflection</a></li><li><a class="tocitem" href="../aggregation/">Bag aggregation</a></li><li><a class="tocitem" href="../leaf_data/">Data in leaves</a></li><li><a class="tocitem" href="../missing/">Missing data</a></li><li class="is-active"><a class="tocitem" href="">Custom nodes</a><ul class="internal"><li><a class="tocitem" href="#Custom-nodes"><span>Custom nodes</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/musk/musk/">Musk</a></li><li><a class="tocitem" href="../../examples/gnn/">GNNs in 16 lines</a></li><li><a class="tocitem" href="../../examples/dag/">DAGs</a></li><li><a class="tocitem" href="../../examples/jsons/">Processing JSONs</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">External tools</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tools/hierarchical/">HierarchicalUtils.jl</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Public API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/aggregation/">Aggregation</a></li><li><a class="tocitem" href="../../api/bags/">Bags</a></li><li><a class="tocitem" href="../../api/data_nodes/">Data nodes</a></li><li><a class="tocitem" href="../../api/model_nodes/">Model nodes</a></li><li><a class="tocitem" href="../../api/special_arrays/">Special Arrays</a></li><li><a class="tocitem" href="../../api/switches/">Switches</a></li><li><a class="tocitem" href="../../api/utilities/">Utilities</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../citation/">Citation</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href="">Custom nodes</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Custom nodes</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CTUAvastLab/Mill.jl/blob/master/docs/src/manual/custom.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a></div></header><article class="content" id="documenter-page"><h2 id="Custom-nodes"><a class="docs-heading-anchor" href="#Custom-nodes">Custom nodes</a><a id="Custom-nodes-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-nodes" title="Permalink"></a></h2><p><a href="https://github.com/CTUAvastLab/Mill.jl"><code>Mill.jl</code></a> data nodes are lightweight wrappers around data, such as <code>Array</code>, <code>DataFrame</code>, and others. It is of course possible to define a custom data (and model) nodes. A useful abstraction for implementing custom data nodes suitable for most cases  is <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a>, which you can easily use to extend the functionality of <code>Mill</code>.</p><h3 id="Unix-path-example"><a class="docs-heading-anchor" href="#Unix-path-example">Unix path example</a><a id="Unix-path-example-1"></a><a class="docs-heading-anchor-permalink" href="#Unix-path-example" title="Permalink"></a></h3><p>Let's define a custom node type for representing path names in Unix and one custom model type for processing it. <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a> serves as a bolierplate for simple extension of <code>Mill</code> ecosystem. We start by by defining an example of such node:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; ds = LazyNode{:Path}(["/var/lib/blob_files/myfile.blob"])</code><code class="nohighlight hljs ansi" style="display:block;">LazyNode{:Path, Vector{String}, Nothing}:
 "/var/lib/blob_files/myfile.blob"</code></pre><p>Entirely new type is not needed, because we can dispatch on the first type parameter. Specifically, <code>:Path</code> "tag" in this case defines a special kind of <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a>. Consequently, we can define multiple variations of custom <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a> without any conflicts in dispatch.</p><p>As a next step, we extend the <a href="../../api/data_nodes/#Mill.unpack2mill"><code>Mill.unpack2mill</code></a> function, which always takes one <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a> and produces an arbitrary <code>Mill</code> structure. We will represent individual file and directory names (as obtained by <code>splitpath</code>) using an <a href="../../api/special_arrays/#Mill.NGramMatrix"><code>NGramMatrix</code></a> representation and, for simplicity, the whole path as a bag of individual names:</p><pre><code class="language-julia hljs">function Mill.unpack2mill(ds::LazyNode{:Path})
    ss = splitpath.(ds.data)
    x = NGramMatrix(reduce(vcat, ss), 3)
    BagNode(ArrayNode(x), Mill.length2bags(length.(ss)))
end</code></pre><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; Mill.unpack2mill(ds)</code><code class="nohighlight hljs ansi" style="display:block;">BagNode 	# 1 obs, 104 bytes
  └── ArrayNode(2053×5 NGramMatrix with Int64 elements) 	# 5 obs, 212 bytes</code></pre><p>Also, note that the node keeps an array of strings instead of just one string. This is because we want our node to be able to hold multiple observations than one. Methods such as <a href="../../api/data_nodes/#Mill.catobs"><code>catobs</code></a> work as expected:</p><pre><code class="language-julia hljs">ds1 = LazyNode{:Path}(["/var/lib/blob_files/myfile.blob"])
ds2 = LazyNode{:Path}(["/var/lib/python"])</code></pre><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; ds = catobs(ds1, ds2)</code><code class="nohighlight hljs ansi" style="display:block;">LazyNode{:Path, Vector{String}, Nothing}:
 "/var/lib/blob_files/myfile.blob"
 "/var/lib/python"</code></pre><p>The <a href="../../api/data_nodes/#Mill.unpack2mill"><code>Mill.unpack2mill</code></a> function is called lazily during the inference by a <a href="../../api/model_nodes/#Mill.LazyModel"><code>LazyModel</code></a> counterpart.</p><p><a href="../reflectin/#Model-reflection">Model reflection</a> works too:</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pm = reflectinmodel(ds, d -&gt; Dense(d, 3))</code><code class="nohighlight hljs ansi" style="display:block;">LazyModel{Path}
  └── BagModel ↦ BagCount([SegmentedMean(3); SegmentedMax(3)]) ↦ ArrayModel(Dense(7, 3)) 	# 4 arrays, 30 params, 280 bytes
        └── ArrayModel(Dense(2053, 3)) 	# 2 arrays, 6_162 params, 24.148 KiB</code></pre><p>We can use the obtained model to perform inference as we would do with any other model.</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; pm(ds).data</code><code class="nohighlight hljs ansi" style="display:block;">3×2 Matrix{Float32}:
  0.34494    0.294562
  0.992065   0.889685
 -0.307104  -0.282527</code></pre><h3 id="Adding-custom-nodes-without-[LazyNode](@ref)"><a class="docs-heading-anchor" href="#Adding-custom-nodes-without-[LazyNode](@ref)">Adding custom nodes without </a><a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a><a id="Adding-custom-nodes-without-[LazyNode](@ref)-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-custom-nodes-without-[LazyNode](@ref)" title="Permalink"></a></h3><p>The solution using <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a> is sufficient in most scenarios. For other cases, it is recommended to equip custom nodes with the following functionality:</p><ul><li>allow nesting (if needed)</li><li>implement <a href="../../api/data_nodes/#Mill.subset"><code>Mill.subset</code></a> and optionally <code>Base.getindex</code> to obtain subsets of observations. <code>Mill</code> already defines <a href="../../api/data_nodes/#Mill.subset"><code>Mill.subset</code></a> for common datatypes, which can be used.</li><li>allow concatenation of nodes with <a href="../../api/data_nodes/#Mill.catobs"><code>catobs</code></a>. Optionally, implement <code>reduce(catobs, ...)</code> as well to avoid excessive compilations if a number of arguments will vary a lot</li><li>define a specialized method for <code>StatsBase.nobs</code></li><li>register the custom node with <a href="../../tools/hierarchical/#HierarchicalUtils.jl">HierarchicalUtils.jl</a> to obtain pretty printing, iterators and other functionality</li></ul><p>Here is an example of a custom node with the same functionality as in the <a href="#Unix-path-example">Unix path example</a> section:</p><pre><code class="language-julia hljs">using Mill

import Base: getindex, show
import Mill: catobs, data, metadata, VecOrRange, AbstractMillNode, reflectinmodel
import Flux
import StatsBase: nobs
import HierarchicalUtils: NodeType, LeafNode

struct PathNode{S &lt;: AbstractString, C} &lt;: AbstractMillNode
    data::Vector{S}
    metadata::C
end

PathNode(data::Vector{S}) where {S &lt;: AbstractString} = PathNode(data, nothing)
Base.show(io::IO, n::PathNode) = print(io, "PathNode ($(nobs(n)) obs)")

Base.ndims(n::PathNode) = Colon()
nobs(n::PathNode) = length(n.data)
catobs(ns::PathNode) = PathNode(vcat(data.(ns)...), catobs(metadata.(as)...))
Base.getindex(n::PathNode, i::VecOrRange{&lt;:Int}) = PathNode(subset(data(x), i),
                                                            subset(metadata(x), i))
NodeType(::Type{&lt;:PathNode}) = LeafNode()</code></pre><p>We also have to define a corresponding model node type which will be a counterpart processing the data:</p><p>The solution using <a href="../../api/data_nodes/#Mill.LazyNode"><code>LazyNode</code></a> is sufficient in most scenarios. For other cases, it is recommended to equip custom nodes with the following functionality:</p><p>Flux.@functor PathModel show(io::IO, n::PathModel) = print(io, "PathModel") NodeType(::Type{&lt;:PathModel}) = LeafNode()</p><p>path2mill(ds::PathNode) = path2mill(ds.data) path2mill(ss::Vector{&lt;:AbstractString}) = reduce(catobs, map(path2mill, ss)) function path2mill(s::String)     ss = splitpath(s)     BagNode(ArrayNode(NGramMatrix(ss, 3)), AlignedBags([1:length(ss)])) end</p><p>(m::PathModel)(x::PathNode) = m.m(m.path2mill(x))</p><p>function reflectinmodel(ds::PathNode, args...)     pm = reflectinmodel(path2mill(ds), args...)     PathModel(pm, path2mill) end nothing # hide</p><pre><code class="nohighlight hljs">
Example of usage:
</code></pre><p>@repl custom ds = PathNode(["/etc/passwd", "/home/tonda/.bashrc"]) pm = reflectinmodel(ds, d -&gt; Dense(d, 3)) pm(ds).data ```</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../missing/">« Missing data</a><a class="docs-footer-nextpage" href="../../examples/musk/musk/">Musk »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.13 on <span class="colophon-date" title="Wednesday 2 March 2022 15:55">Wednesday 2 March 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>